<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <script src="./assets/lodash.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.js"></script>
    <script>
        function Component(props) {
            this.props = props
        }
        Component.prototype.setState = function (partialState) {
            this.state = {
                ...this.state,
                ...partialState
            };
            this.parent.innerHTML = '';
            this.parent.appendChild(renderChildren(this.render()));

        };
        const createElement = function(type, config, ...children) {
            let props = {};

            // 将第二个参数config和第三个参数children合并成一个
            if (config !== null) {
                props = _.defaultsDeep({}, config);
            }

            if (children.length >= 1) {
                props.children = children.length === 1 ? children[0] : children
            }

            return {
                type: type,
                props: props
            };
        };
        const React = {
            Component,
            createElement
        };
        const registrationNames = ['onClick'];

        function render (reactElement, container) {
            const Component = reactElement.type;
            const inst = new Component();
            inst.parent = container;

            const children = inst.render();
            container.appendChild(renderChildren(children))
        }

        function renderChildren(node) {
            const {type, props} = node;
            const dom = document.createElement(type);

            function appendChild(childNode) {
                if (['string', 'number'].some(val => typeof childNode === val)) {
                    dom.textContent = childNode
                } else {
                    dom.appendChild(renderChildren(childNode))
                }
            }

            _.entries(props).map(([key, value]) => {
                if (key === 'children') {
                    Array.isArray(value)
                        ? value.map(child => appendChild(child))
                        : appendChild(value)
                }
                else if (registrationNames.includes(key)) {
                    let eventType = key.slice(2).toLocaleLowerCase();
                    dom.addEventListener(eventType, value);
                    dom.setAttribute([key], value)
                }
                else {
                    dom.setAttribute(key, value)
                }
            });

            return dom
        }


        const ReactDOM = {
            render
        };
    </script>
    <div id="container"></div>
    <script type="text/babel">
        class HelloWorld extends React.Component {
            constructor () {
                super();
                this.state = {
                    count: 1
                };
            }
            addCount = () => {
                this.setState({count: this.state.count + 1});
                console.log(this.state.count)
            };
            render () {
                return (
                    <div>
                        <div>{this.state.count}</div>
                        <button onClick={_ => this.addCount()}>+1</button>
                    </div>
                )
            }
        }

        ReactDOM.render(
            <HelloWorld />,
            document.getElementById('container')
        );
    </script>
</body>
</html>
