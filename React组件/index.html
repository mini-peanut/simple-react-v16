<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <script src="../assets/react.development.js"></script>
    <script src="../assets/react-dom.development.js"></script>
    <script src="../assets/lodash.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.js"></script>
    <script>
        function Component(props) {
            this.props = props
        }
        Component.prototype.setState = function (partialState) {
            if (typeof partialState === "function") {
                partialState = partialState(this.state)
            }
            this.state = {
                ...this.state,
                ...partialState
            };
            this.parent.innerHTML = '';
            let children = this.render();
            children = Array.isArray(children) ? children : [children];
            children.map(item => this.parent.appendChild(renderChildren(item)))
        };
        const createElement = function(type, config, ...children) {
            let props = {};

            // 将第二个参数config和第三个参数children合并成一个
            if (config !== null) {
                props = _.defaultsDeep({}, config);
            }

            if (children.length >= 1) {
                props.children = children.length === 1 ? children[0] : children
            }

            return {
                type: type,
                props: props
            };
        };
        const React = {
            Component,
            createElement
        };
        const registrationNames = ['onClick'];

        function render (reactElement, container) {
            const Component = reactElement.type;
            const inst = new Component();
            inst.parent = container;

            let children = inst.render();
            children = Array.isArray(children) ? children : [children]
            children.map(item => container.appendChild(renderChildren(item)))
        }

        function renderChildren(node) {
            const {type, props} = node;
            const dom = document.createElement(type);

            _.entries(props).map(([key, value]) => {
                if (key === 'children') {
                    Array.isArray(value)
                        ? value.map(child => appendChild(dom, child))
                        : appendChild(dom, value)
                }
                else if (registrationNames.includes(key)) {
                    let eventType = key.slice(2).toLocaleLowerCase();
                    dom.addEventListener(eventType, value);
                    dom.setAttribute([key], value)
                }
                else {
                    dom.setAttribute(key, value)
                }
            });

            return dom
        }

        function appendChild(parent, childNode) {
            if (['string', 'number'].some(val => typeof childNode === val)) {
                parent.textContent = childNode
            } else {
                parent.appendChild(renderChildren(childNode))
            }
        }

        const ReactDOM = {
            render
        };
    </script>
    <div id="app"></div>
    <script type="text/babel">
        class ClickCounter extends Component{
            constructor(props) {
                super(props);
                this.state = {count: 0};
                this.handleClick = this.handleClick.bind(this);
                console.log('constructor')
            }

            handleClick() {
                this.setState((state) => {
                    return {count: state.count + 1};
                });
            }

            componentDidMount () {
                console.log('componentDidMount')
            }

            componentDidUpdate () {
                console.log('componentDidUpdate')
            }

            render() {
                return [
                    <button key="1" onClick={_ => this.handleClick()}>Update counter</button>,
                    <span key="2">{this.state.count}</span>
                ]
            }
        }

        ReactDOM.render(<ClickCounter />, document.getElementById('app'))
    </script>
</body>
</html>
